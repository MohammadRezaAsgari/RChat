{% extends "home_base.html" %}

{% block title %}RChat Home{% endblock %}

{% block content %}
<div class="home-container">

    <!-- Sidebar -->
    <div class="sidebar">
        <h2>Hi {{request.user.username}}!
        
        <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button class="logout-btn">Logout</button>
        </form>
        </h2>

        <h3>Chats</h3>
        <a href="#" id="toggle-new-chat" class="button">+ New Chat</a>
    
        <ul class="chat-list">
            {% for chat in chats %}
                <li>
                    <a href="{% url 'home_active_chat' chat.uuid %}" class="{% if active_chat and active_chat.uuid == chat.uuid %}active{% endif %}">
                        {% if chat.is_group_chat %}
                            {{ chat.name|default:"Group Chat" }}
                        {% else %}
                            {% for u in chat.participants.all %}
                                {% if u != request.user %}
                                    {{ u.username }}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </a>
                </li>
            {% empty %}
                <li>No chats yet.</li>
            {% endfor %}
        </ul>

        <!-- New Chat Form -->
        <div id="new-chat-form">
            <form method="post">
                {% csrf_token %}
                <input type="text" name="username" placeholder="Enter username..." required>
                <button type="submit">Start Chat</button>
            </form>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-area">
        {% if active_chat %}
            <h3>
                {% if active_chat.is_group_chat %}
                    {{ active_chat.name|default:"Group Chat" }}
                {% else %}
                    {% for u in active_chat.participants.all %}
                        {% if u != request.user %}
                            {{ u.username }}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </h3>

            <div id="messages" class="messages">
                {% for message in active_chat.messages.all %}
                    <div class="message-item {% if message.sender == request.user %}me{% endif %}">
                        <div class="message-bubble">
                            <p><b>{% if message.sender != request.user and active_chat.is_group_chat %} {{ message.sender.username }}: {% endif %}</b>
                            {{ message.content }}</p>
                            <span class="message-time">
                                {{ message.timestamp|date:"M d, H:i" }}
                            </span>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="chat-input">
                <input id="chat-message-input" type="text" placeholder="Type a message...">
                <button id="chat-message-submit">Send</button>
            </div>

            <script>
                const chatUuid = "{{ active_chat.uuid }}";
                const ws = new WebSocket("ws://" + window.location.host + "/ws/chat/" + chatUuid + "/");

                ws.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    const log = document.getElementById("messages");

                    const div = document.createElement("div");
                    div.className = "message-item" + (data.user == "{{ request.user.username }}" ? " me" : "");

                    const bubble = document.createElement("div");
                    bubble.className = "message-bubble";

                    const content = document.createElement("p");
                    content.innerText = data.message;

                    const time = document.createElement("span");
                    time.className = "message-time";
                    time.innerText = data.timestamp;

                    bubble.appendChild(content);
                    bubble.appendChild(time);
                    div.appendChild(bubble);
                    log.appendChild(div);

                    log.scrollTop = log.scrollHeight;
                };

                document.getElementById("chat-message-submit").onclick = function() {
                    const input = document.getElementById("chat-message-input");
                    if(input.value.trim() === "") return;

                    ws.send(JSON.stringify({
                        'message': input.value
                    }));

                    input.value = '';
                };
            </script>
        {% else %}
            <p>Select a chat from the left to start messaging.</p>
        {% endif %}
    </div>

</div>
{% endblock %}